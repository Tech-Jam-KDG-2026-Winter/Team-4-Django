<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jellyfish Splash</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>

    <div class="bubble b1"></div>
    <div class="bubble b2"></div>
    <div class="bubble b3"></div>
    <div class="bubble b4"></div>

    <div class="jellyfish-container">

        <svg class="jellyfish-svg" viewBox="0 0 600 779" xmlns="http://www.w3.org/2000/svg">
            <path class="cls-head" d="M600 190C600 272.843 465.685 190 300 190C134.315 190 0 272.843 0 190C0 107.157 134.315 0 300 0C465.685 0 600 107.157 600 190Z" />
            <g class="cls-tentacles">
                <path d="M116 258.819C116 258.819 106 296.601 106 321.319C106 346.037 116 383.819 116 383.819C116 383.819 126 421.601 126 446.319C126 471.037 116 508.819 116 508.819C116 508.819 106 546.601 106 571.319C106 596.037 116 633.819 116 633.819C116 633.819 126 671.911 126 696.319C126 720.727 116 758.819 116 758.819" stroke-linecap="round"/>
                <path d="M300 258.819C300 258.819 290 296.601 290 321.319C290 346.037 300 383.819 300 383.819C300 383.819 310 421.601 310 446.319C310 471.037 300 508.819 300 508.819C300 508.819 290 546.601 290 571.319C290 596.037 300 633.819 300 633.819C300 633.819 310 671.911 310 696.319C310 720.727 300 758.819 300 758.819" stroke-linecap="round"/>
                <path d="M484 258.819C484 258.819 474 296.601 474 321.319C474 346.037 484 383.819 484 383.819C484 383.819 494 421.601 494 446.319C494 471.037 484 508.819 484 508.819C484 508.819 474 546.601 474 571.319C474 596.037 484 633.819 484 633.819C484 633.819 494 671.911 494 696.319C494 720.727 484 758.819 484 758.819" stroke-linecap="round"/>
            </g>
        </svg>

        <div class="fragment pink"></div>
        <div class="fragment green"></div>
        <div class="fragment blue"></div>
    </div>

    <!-- ログインフォーム -->
    <div style="position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; z-index: 10;">
        <form id="login-form" style="background: rgba(255, 255, 255, 0.95); padding: 24px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
            <h2 style="margin: 0 0 20px 0; text-align: center; color: #1B263B; font-size: 24px;">ログイン</h2>
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; color: #334155; font-weight: 500;">ユーザー名</label>
                <input type="text" id="username" name="username" required 
                       style="width: 100%; padding: 12px; border: 1px solid #B1BDD0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #334155; font-weight: 500;">パスワード</label>
                <input type="password" id="password" name="password" required 
                       style="width: 100%; padding: 12px; border: 1px solid #B1BDD0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
            </div>
            <button type="submit" 
                    style="width: 100%; padding: 12px; background: #1B263B; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 500; cursor: pointer;">
                ログイン
            </button>
            <div style="margin-top: 16px; text-align: center;">
                <a href="#" id="register-link" style="color: #1A73E8; text-decoration: none; font-size: 14px;">新規登録はこちら</a>
            </div>
            <div id="error-message" style="margin-top: 12px; color: #dc3545; font-size: 14px; text-align: center; display: none;"></div>
        </form>
    </div>

    <!-- 新規登録フォーム（初期は非表示） -->
    <div id="register-form-container" style="position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; z-index: 10; display: none;">
        <form id="register-form" style="background: rgba(255, 255, 255, 0.95); padding: 24px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
            <h2 style="margin: 0 0 20px 0; text-align: center; color: #1B263B; font-size: 24px;">新規登録</h2>
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; color: #334155; font-weight: 500;">ユーザー名</label>
                <input type="text" id="reg-username" name="username" required 
                       style="width: 100%; padding: 12px; border: 1px solid #B1BDD0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
            </div>
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; color: #334155; font-weight: 500;">メールアドレス（任意）</label>
                <input type="email" id="reg-email" name="email" 
                       style="width: 100%; padding: 12px; border: 1px solid #B1BDD0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
            </div>
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; color: #334155; font-weight: 500;">パスワード</label>
                <input type="password" id="reg-password" name="password" required 
                       style="width: 100%; padding: 12px; border: 1px solid #B1BDD0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #334155; font-weight: 500;">パスワード（確認）</label>
                <input type="password" id="reg-password-confirm" name="password_confirm" required 
                       style="width: 100%; padding: 12px; border: 1px solid #B1BDD0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
            </div>
            <button type="submit" 
                    style="width: 100%; padding: 12px; background: #1B263B; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 500; cursor: pointer;">
                登録
            </button>
            <div style="margin-top: 16px; text-align: center;">
                <a href="#" id="login-link" style="color: #1A73E8; text-decoration: none; font-size: 14px;">ログインはこちら</a>
            </div>
            <div id="register-error-message" style="margin-top: 12px; color: #dc3545; font-size: 14px; text-align: center; display: none;"></div>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const loginFormContainer = loginForm.parentElement;
            const registerFormContainer = document.getElementById('register-form-container');
            const registerLink = document.getElementById('register-link');
            const loginLink = document.getElementById('login-link');
            const errorMessage = document.getElementById('error-message');
            const registerErrorMessage = document.getElementById('register-error-message');

            // ログインフォーム送信
            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                errorMessage.style.display = 'none';
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                try {
                    const response = await fetch('/api/users/login/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ username, password })
                    });

                    let data;
                    try {
                        data = await response.json();
                    } catch (e) {
                        errorMessage.textContent = `サーバーエラー: ${response.status} ${response.statusText}`;
                        errorMessage.style.display = 'block';
                        console.error('JSON parse error:', e, 'Response:', response);
                        return;
                    }

                    if (response.ok) {
                        // トークンをlocalStorageに保存
                        localStorage.setItem('auth_token', data.token);
                        // セッション認証も有効にするため、ページをリロードしてから遷移
                        // モード選択画面へ遷移
                        if (data.user.mode) {
                            window.location.href = '/task-today/';
                        } else {
                            window.location.href = '/mode-question/';
                        }
                    } else {
                        const errorText = data.error || 
                                         data.non_field_errors?.[0] || 
                                         data.username?.[0] || 
                                         data.password?.[0] || 
                                         `ログインに失敗しました (${response.status})`;
                        errorMessage.textContent = errorText;
                        errorMessage.style.display = 'block';
                        console.error('Login error:', data);
                    }
                } catch (error) {
                    errorMessage.textContent = `ネットワークエラー: ${error.message}`;
                    errorMessage.style.display = 'block';
                    console.error('Error:', error);
                }
            });

            // 新規登録フォーム送信
            registerForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                registerErrorMessage.style.display = 'none';
                
                const username = document.getElementById('reg-username').value;
                const email = document.getElementById('reg-email').value;
                const password = document.getElementById('reg-password').value;
                const passwordConfirm = document.getElementById('reg-password-confirm').value;

                if (password !== passwordConfirm) {
                    registerErrorMessage.textContent = 'パスワードが一致しません';
                    registerErrorMessage.style.display = 'block';
                    return;
                }

                try {
                    const response = await fetch('/api/users/register/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            username, 
                            email: email || '', 
                            password, 
                            password_confirm: passwordConfirm 
                        })
                    });

                    let data;
                    try {
                        data = await response.json();
                    } catch (e) {
                        registerErrorMessage.textContent = `サーバーエラー: ${response.status} ${response.statusText}`;
                        registerErrorMessage.style.display = 'block';
                        console.error('JSON parse error:', e, 'Response:', response);
                        return;
                    }

                    if (response.ok) {
                        // トークンをlocalStorageに保存
                        localStorage.setItem('auth_token', data.token);
                        // モード選択画面へ遷移
                        window.location.href = '/mode-question/';
                    } else {
                        const errorText = data.error || 
                                         Object.values(data).flat().join(', ') || 
                                         `登録に失敗しました (${response.status})`;
                        registerErrorMessage.textContent = errorText;
                        registerErrorMessage.style.display = 'block';
                        console.error('Register error:', data);
                    }
                } catch (error) {
                    registerErrorMessage.textContent = `ネットワークエラー: ${error.message}`;
                    registerErrorMessage.style.display = 'block';
                    console.error('Error:', error);
                }
            });

            // フォーム切り替え
            registerLink.addEventListener('click', function(e) {
                e.preventDefault();
                loginFormContainer.style.display = 'none';
                registerFormContainer.style.display = 'block';
            });

            loginLink.addEventListener('click', function(e) {
                e.preventDefault();
                registerFormContainer.style.display = 'none';
                loginFormContainer.style.display = 'block';
            });
        });
    </script>

</body>
</html>